#!/bin/sh
set -eu

# Bootstrapping tools:
#
# - age
# - chezmoi
# - rbw

# TODO(ttlgcc): Port to Linux.

case "$(uname -s)" in
	Darwin)
		export HOMEBREW_NO_ANALYTICS=1
		bash -c "$(curl -fsSL https://github.com/Homebrew/install/raw/HEAD/install.sh)"
		test "$(uname -m)" = arm64 && brew_prefix=/opt/homebrew || brew_prefix=/usr/local
		eval "$($brew_prefix/bin/brew shellenv)"
		brew analytics off
		brew install --quiet age chezmoi rbw
		;;
	*)
		printf 'OS not supported yet\n'
		exit 1
		;;
esac

printf 'bitwarden email? '
head -n1 | xargs rbw config set email
rbw register
rbw login

for key in .config/age/dotfiles.key .ssh/id_ed25519 .ssh/id_ed25519.pub
do
	mkdir -p ~/$(dirname $key)
	rbw get '~'/$key >~/$key
	chmod 400 ~/$key
done

ssh-add ~/.ssh/id_ed25519

chezmoi init --apply tautologicc
chezmoi git config url.'git@github.com:'.insteadOf 'https://github.com/'

yesno 'reboot now' && sudo reboot || :
